<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>Runky | 카카오 로그인</title>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial;
            margin: 40px;
        }

        .box {
            max-width: 560px;
            margin: 0 auto;
            text-align: left;
        }

        .btn {
            padding: 14px 18px;
            border-radius: 10px;
            border: 0;
            cursor: pointer;
            font-size: 16px;
            background: #FEE500;
        }

        .btn2 {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
        }

        .row {
            margin: 16px 0;
        }

        pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 8px;
            white-space: pre-wrap;
        }

        .err {
            color: #b00020;
        }

        code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 6px;
        }

        .kv {
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
<div class="box">
    <h1>카카오로 로그인</h1>

    <div class="row kv">
        <div>origin: <code id="kv-origin"></code></div>
        <div>redirectUri: <code id="kv-ru"></code></div>
    </div>

    <div class="row">
        <button class="btn" id="loginBtn" type="button">카카오로 로그인</button>
        <button class="btn2" id="testPopupBtn" type="button">팝업 차단 테스트</button>
        <!-- ✅ 추가: token-tools.html 이동 버튼 -->
        <button class="btn2" id="tokenToolsBtn" type="button">토큰 도구 열기</button>
    </div>

    <div class="row">
        <pre id="log">(대기 중)</pre>
    </div>
</div>

<script>
    (function () {
        const $ = (id) => document.getElementById(id);
        const $log = $('log');
        const log = (m, err = false) => {
            (err ? console.error : console.log)(m);
            $log.textContent += ($log.textContent ? '\n' : '') + (err ? '[ERROR] ' : '') + m;
            if (err) $log.classList.add('err');
        };

        // --- 환경 ---
        const ORIGIN = (location.origin && location.origin !== 'null')
            ? location.origin
            : (location.protocol + '//' + location.host);

        const CONFIG = {
            KAKAO_CLIENT_ID: "10591b4c28e1de84d6fd5da8ec5c3467",
            REDIRECT_URI: ORIGIN + "/api/auth/login/oauth2/code/kakao", // 카카오 콘솔 등록값과 동일해야 함
            SCOPE: "profile_nickname profile_image",
            BACKEND: ORIGIN,
            POPUP_W: 480, POPUP_H: 720,
            TOKEN_TOOLS: ORIGIN + "/token-tools.html" // ✅ 추가
        };

        $('kv-origin').textContent = ORIGIN;
        $('kv-ru').textContent = CONFIG.REDIRECT_URI;

        if (!ORIGIN.startsWith('http')) {
            log("이 페이지는 file:// 가 아니라 http(s)로 서빙해야 합니다. 예) http://localhost:8080/index.html", true);
        }

        // --- URL 생성 ---
        function buildAuthorizeUrl() {
            const u = new URL("https://kauth.kakao.com/oauth/authorize");
            u.searchParams.set("client_id", CONFIG.KAKAO_CLIENT_ID);
            u.searchParams.set("redirect_uri", CONFIG.REDIRECT_URI);
            u.searchParams.set("response_type", "code");
            const scope = (CONFIG.SCOPE || "").replace(/,/g, " ").replace(/\s+/g, " ").trim();
            if (scope) u.searchParams.set("scope", scope);
            const state = Math.random().toString(36).slice(2);
            sessionStorage.setItem("oauth_state", state);
            u.searchParams.set("state", state);
            return u.toString();
        }

        function centerSpecs(w, h) {
            try {
                const y = (window.top.outerHeight / 2) + window.top.screenY - (h / 2);
                const x = (window.top.outerWidth / 2) + window.top.screenX - (w / 2);
                return `width=${w},height=${h},left=${x},top=${y},resizable=yes,scrollbars=yes`;
            } catch {
                return `width=${w},height=${h},resizable=yes,scrollbars=yes`;
            }
        }

        async function decideAndRedirect() {
            try {
                const res = await fetch(CONFIG.BACKEND + "/api/auth/token/refresh", {
                    method: "POST",
                    credentials: "include"
                });
                if (res.ok) {
                    log("로그인 완료: 홈으로 이동합니다.");
                    window.location.replace("/");
                } else {
                    log(`신규 가입(flow). HTTP ${res.status} → /signup.html로 이동`);
                    window.location.replace("/signup.html");
                }
            } catch (e) {
                log("상태 확인 중 오류: " + (e?.message || e), true);
                window.location.replace("/signup.html");
            }
        }

        function watchPopupAndAutoClose(popup) {
            const targetPrefix = CONFIG.BACKEND + "/api/auth/login/oauth2/code/kakao";
            const t = setInterval(() => {
                if (!popup || popup.closed) {
                    clearInterval(t);
                    return;
                }
                try {
                    if (popup.location.href.startsWith(targetPrefix)) {
                        popup.close();
                        clearInterval(t);
                        decideAndRedirect();
                    }
                } catch {
                    // 아직 카카오 도메인 → 접근 불가, 계속 감시
                }
            }, 300);
        }

        function onKakaoLoginClick(ev) {
            ev?.preventDefault?.();
            try {
                const url = buildAuthorizeUrl();
                log("authorize URL 생성 완료");
                const popup = window.open(url, "kakao_login", centerSpecs(CONFIG.POPUP_W, CONFIG.POPUP_H));
                if (!popup) {
                    alert("팝업을 허용해주세요.");
                    log("팝업 차단으로 window.open()이 null 반환", true);
                    return;
                }
                log("카카오 로그인 팝업을 열었습니다.");
                watchPopupAndAutoClose(popup);
            } catch (e) {
                log("onKakaoLoginClick 예외: " + (e?.message || e), true);
            }
        }

        function onTestPopup() {
            const p = window.open("about:blank", "test_popup", centerSpecs(360, 360));
            if (!p) {
                alert("팝업이 차단되어 있습니다. 브라우저 주소창 우측의 팝업 차단 해제를 눌러주세요.");
                log("테스트 팝업 실패(window.open null). 팝업 차단 의심.", true);
                return;
            }
            p.document.write("<p>팝업 허용 OK</p>");
            log("테스트 팝업 열기 성공 → 팝업 차단 아님.");
            try {
                p.close();
            } catch {
            }
        }

        // ✅ 추가: token-tools.html로 이동
        function onOpenTokenTools() {
            log("토큰 도구 페이지로 이동합니다: " + CONFIG.TOKEN_TOOLS);
            window.location.href = CONFIG.TOKEN_TOOLS; // 같은 탭 이동
            // window.open(CONFIG.TOKEN_TOOLS, "_blank"); // 새 탭을 원하면 이 줄 사용
        }

        // 이벤트 바인딩
        $('loginBtn').addEventListener('click', onKakaoLoginClick);
        $('testPopupBtn').addEventListener('click', onTestPopup);
        $('tokenToolsBtn').addEventListener('click', onOpenTokenTools); // ✅ 추가

        // 초기 로그
        log("준비 완료. '카카오로 로그인'을 눌러 진행하세요.");
    })();
</script>
</body>
</html>
